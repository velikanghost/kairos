// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

model User {
  id        String   @id @default(uuid())

  // User identifier (wallet address)
  walletAddress String   @unique // User's wallet address (used as primary identifier)

  // Legacy Web3Auth fields (deprecated, for backwards compatibility)
  web3AuthId String?   @unique // DEPRECATED: Web3Auth verifier ID
  verifier   String?   // DEPRECATED: Verifier name

  // User info
  email      String?
  name       String?

  // Legacy addresses (deprecated)
  eoaAddress String?  @unique // DEPRECATED: EOA address from Web3Auth
  smartAccountAddress String? @unique // DEPRECATED: User's MetaMask Smart Account
  smartAccountImplementation String? // DEPRECATED: Implementation type

  // Timestamps
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  lastLoginAt DateTime?

  // Relations
  permissions Permission[]
  strategies  DCAStrategy[]
  sessionAccounts SessionAccount[]

  @@index([walletAddress])
  @@index([web3AuthId])
  @@index([eoaAddress])
}

model SessionAccount {
  id        String   @id @default(uuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Session account address (MetaMask Smart Account)
  address   String   @unique

  // Encrypted private key (AES-256-GCM encrypted JSON)
  encryptedPrivateKey String

  // Implementation type
  implementation String @default("Hybrid") // 'Hybrid', 'Kernel', etc.

  // Lifecycle
  isActive  Boolean  @default(true)
  expiresAt DateTime? // Optional expiry for session accounts

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([address])
  @@index([isActive])
}

model Permission {
  id        String   @id @default(uuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Session account that will execute using this permission
  sessionAccountId String
  sessionAccountAddress String // Denormalized for quick lookups

  // Permission details from ERC-7715
  permissionContext String // Unique identifier for this permission grant
  delegationManager String // DelegationManager contract address
  permissionType    String // e.g., "native-token-periodic", "erc20-spending-limit"
  chainId           Int    // Chain ID where permission is valid

  // Permission parameters (from ERC-7715 response)
  permissionData Json   // Full permission object from MetaMask

  // Lifecycle
  expiresAt DateTime
  revokedAt DateTime?

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([sessionAccountId])
  @@index([permissionContext])
  @@index([expiresAt])
}

model DCAStrategy {
  id        String   @id @default(uuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  pairId    String   // e.g., "USDC/ETH"

  // Base strategy config
  frequency String   // '5min', 'hourly', 'daily', 'weekly'
  baseAmount String  // Base amount in wei (as string for BigInt)
  slippage  Float    @default(0.5) // Slippage tolerance percentage

  // Permission metadata from MetaMask
  permissionHash String? // Hash of granted permission context
  permissionExpiry DateTime?

  // Smart features toggles
  enableSmartSizing Boolean @default(true)
  enableVolatilityAdjustment Boolean @default(true)
  enableLiquidityCheck Boolean @default(true)

  // Router preference (Uniswap V4 only)
  router String @default("uniswap_v4") // 'uniswap_v4'

  // Status tracking
  isActive Boolean @default(true)
  nextCheckTime DateTime

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  executions Execution[]

  @@index([userId])
  @@index([nextCheckTime])
  @@index([isActive])
}

model Execution {
  id String @id @default(uuid())
  strategyId String
  strategy DCAStrategy @relation(fields: [strategyId], references: [id], onDelete: Cascade)

  // Decision metadata
  decision Json // Full ExecutionDecision object
  recommendedAmount String // Recommended amount in wei

  // Execution status
  status String // 'pending' | 'sent_to_frontend' | 'executed' | 'skipped' | 'failed'
  txHash String? // Transaction hash if executed
  errorMessage String? // Error details if failed

  // Market conditions at time of decision
  price Float
  volatility Float
  liquidityScore Float
  trend String? // 'bullish' | 'bearish' | 'neutral'

  // Timestamps
  createdAt DateTime @default(now())
  executedAt DateTime?

  @@index([strategyId])
  @@index([status])
  @@index([createdAt])
}

model MarketSnapshot {
  id String @id @default(uuid())
  pairId String

  // Price data
  price Float
  sqrtPriceX96 String // Raw price from swap

  // Volume data
  volume24h Float
  volumeChange Float // Percentage change

  // Liquidity data
  totalLiquidity String // Total liquidity in pool
  liquidityScore Float // Normalized 0-1

  // Computed indicators
  volatility Float
  ma7 Float? // 7-period moving average
  ma30 Float? // 30-period moving average
  trend String? // 'bullish' | 'bearish' | 'neutral'

  // Block info
  blockNumber BigInt
  timestamp DateTime

  createdAt DateTime @default(now())

  @@index([pairId])
  @@index([timestamp])
  @@unique([pairId, blockNumber])
}
